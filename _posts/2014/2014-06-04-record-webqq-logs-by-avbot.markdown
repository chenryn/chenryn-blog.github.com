---
layout: post
title: 用 avbot 机器人记录 QQ 群聊天记录
category: devops
---

这是一件蛮有趣的事情。我因为做 logstash 的 QQ 群管理员，碰到了一个幸福的烦恼：群里有不少高水平且乐于分享的朋友时常给人解答问题，而且一来一回的能牵扯出来不少让人眼前一亮的实践，但是 QQ 聊天记录不像邮件列表和 IRC 那样可以很方便的长期保存共享给后来人学习查找！这简直是国内参与开源技术最头疼的一件事情了，知识没法复用，偏偏越是需要这些知识的人，越是喜欢通过 QQ 来寻求帮助！前两天偶然想到，其实可以通过机器人潜水进来获取聊天记录，然后发布出来！询问了一下 [@比尔盖子V](http://weibo.com/biergaizi) 童鞋，他推荐给我 [avbot](http://wiki.avplayer.org/Avbot) 项目。#妈蛋这名字怎能不吐槽#

作者非常 nice 的提供好了 RPM 可以直接安装在服务器上。所以安装步骤真的就没啥可讲的了。

不过这个项目本意是做 QQ、IRC 和 XMPP 的互联互通，所以把心思用来了 `--map` 的实现，作为我们这里只想单单记录 QQ 群聊天记录来说，它不支持指定只获取某个群的记录，所以最好的办法就是新申请一个 QQ 号，只加这一个群……

运行起来以后，会在当前目录下生成一个 `avlog.db` 库，记录聊天记录，同时生成一个 QQ 群号命名的目录，里面按日期存放当天的聊天记录的 HTML 文件。直接用 nginx 发布出来就好啦！

基本功能就是这样，下一步扩展优化的话，主要有几步：

1. 需要写一个 index.html 来做索引链接和搜索。avbot 本身在 6176 端口提供了一个 `/search?channel=*&q=*date=` 的搜索入口，但是亲测发现似乎只有搜索英文才行，搜中文会直接把全部内容都返回出去，这可不行(奇怪的是官方demo没这个问题，明天得找找是不是中文编码不对)。因为有 sqlite，如果写 web 页做起来应该很简单，不过我想联系一下 js，而且现在跑在国外服务器上，也不像用动态网页占资源。
2. 如果想跟 github 做 hubot 一样用 qqbot 来推动 devops，那么让机器人自己发信息就是很重要的一步。本来应该直接 `curl -XPOST ip:6176/message` 就可以发的。但是亲测发现虽然返回 done 响应，而且 sqlite 里也插入了内容，但是实际 QQ 群里没收到！这一步比较奇怪，因为如果我在 QQ 群窗口里发 `.qqbot help` 指令，是可以收到 avbot 发出的响应的，这说明并不是 WebQQ 改过协议了。

BTW，想了解 logstash 群聊天内容的，可以先按照右边 url 的格式自己去 <http://logstash.chenlinux.com/none/20140604.html> 查看原始 html 内容。
