---
layout: post
title: 腾讯云技术沙龙笔记
category: cloud
tags:
  - nginx
  - hadoop
---

昨天去车库咖啡听了 InfoQ 办的腾讯云图技术沙龙，今天又听了 CSDN 办的开源技术大会上腾讯云的宣讲(没错，就是那个发明了"内部开源"概念的意思)，总的来说，幸亏去了昨天的！

沙龙包括三个主题：

手机推送服务
===================

手机推送其实是一个很难有亮点的服务，我之前试用过免费的 JPush 极光推送服务，应该说大家都差不多——引用SDK，通过 RESTful 接口或者网页后台发布通知。

从业务上说，腾讯云提出一个精准投放的推送概念。
这其实跟后面的多维度数据是联系在一起的，腾讯因为本身(可怕)的数据收集能力，可以很容易的区分几个基础维度——年龄、性别、地域。
(今天午饭跟[@刘江总编]()在一起，他谈到CSDN如何跟技术社区、出版社一起做技术书籍时，提到类似问题，CSDN 上也有千万级的用户，但是怎么高质量的做推荐才不透支信誉或者徒劳无功呢？)

不过在技术周边介绍中，还是聊到了腾讯的 L5 里的技术点，在这记录一下：

起因是说到**服务扩容，新服务器上线时会自动根据响应质量动态调整其在集群中的权重**。

这里我跟[@liu点cy]()、[@守住每一天]()先后猜测并推论了几种在 Nginx 的 upstream 上的实现方式及相关技术。

* [ngx_dupt_module]()
* [ngx_lua_upstream_module]()
* [Serf + Shell + Nginx]()

不过这几种方案一般常见的用途都是上下线而不是权重调整。

那么就涉及到下一步问题：**怎么评定响应质量**？

Nginx 里是有个 [HealthCheck]() 模块，不过还很基础。
于是联想到 LVS 项目中的调度算法，常见的RR、LC、LBLC和LBLCR，少见的还有NQ、SED。这都算是根据 RS 的情况智能调整流量导向。

后来跟讲师交流，稍微了解到了 L5 内部的一点信息。

1. 流量到应用服务之前会经过两层调度(暂称为DNS agent和local agent)；
2. DNS agent 负责多个 local agent 之间的流量调度；
3. local agent 只负责本组(原话是本机)的应用服务的流量权重调整；
4. 一个新服务器上线，首先要经过一次镜像流量的试运行，达到5个9后才正式上线；
5. local agent将收到的每秒10万个请求分配 1% 给新服务器，根据平均响应延时和成功率，判定是否合格，合格就继续加流量；
6. 如果某个服务器被判定不合格了，比如低于5个9了，也并不是直接剔除，而是减流量；除非直接成功率只有85%这样，那就是直接踢。

从流程里"本机"还是"本组"的用词，很容易让我联想到类似 docker 或者说 PAAS 平台的做法。
我个人猜测确实有可能就是一组服务器，但是同时也是在一台真实主机上的多个容器。

*这种做法应该适合业务运维尝试；CDN 方面，upstream 列表每次变动都会带来巨大的回源压力，反而是越少变动越好*

多维度数据分析
===================

前面提到了腾讯数据分析上最常用的几个维度就是年龄、性别和地域。但其实做数据挖掘维度是超级多的，讲师举了不少例子。

从腾讯云的概念上来说，这个数据分析主要是几个层次。

1. 基础的经过整理和运算得到的 TopView。这个应该就是 Hive 里的表，按照讲师所说，TopView 里有 30 个左右的维度。
   从交流来看，这个 Hive 表内容应该就是以 QQ 号为中心的用户行为数据。每天从原始数据里花点时间更新这个表。
2. 选取需要的维度信息做 RollUp。也就是从 TopView 的30个维度数据中选取几个维度做统计分析。这个就是排列组合问题，挨个硬算了。
3. 合作用户如果有自定义维度，并且勾选这个维度做统计分析，就要先退回到计算 TopView 这步，把自定义维度按照 TopView 的处理方式来做。

因为对 Hadoop 的 Map/Reduce 稍有了解，也用过 Hive，所以这里的东西不算太难理解。
其实整个重点是在如何用用户行为日志整理得到 TopView 这块，但是这块属于实现问题，没什么太多可讲的。

在边听演讲的时候我也边思考了一下如果这个问题用 Elasticsearch 做，会怎么样？

由于ES不需要定义 schema，所以类似 TopView 整理这段应该更轻松一些；
RollUp 计算就是写 [bool query](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html)。
这个效率如何我不太了解。

(今天的会场上有介绍腾讯大数据平台的，应该跟这个多维度分析不是一个平台，今天的讲师说到他们的平台除了Hadoop这套还用到了pgsql)

移动动态加速
===================

这一部分是个人比较关心的部分。移动来源占比越来越大，移动网络质量却一如既往的复杂和烂。如何有效提高移动访问质量现在也是大家都关心的问题，本周网宿也刚发布了他们的私有协议加速产品。

腾讯的做法是也提供了 SDK，但本质上没有做完全的私有协议优化而是尽量利用可靠的自建私有网络。

